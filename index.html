<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fleqpe Games</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link href="styles.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-900 text-white">
    <div id="header-placeholder"></div>

    <!-- Main content -->
    <div class="container mx-auto px-5 py-10">
      <div
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"
        id="game-grid"
      >
        <!-- Game Cards will be dynamically generated here -->
      </div>
    </div>

    <footer class="text-center py-6 bg-gray-800 mt-10">
      &copy; 2024 Fleqpe Games. All rights reserved.
    </footer>

    <!-- Modal for displaying update notes -->
    <div id="updateModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 class="text-lg font-semibold mb-4">Update Notes</h2>
        <div id="update-content"></div>
      </div>
    </div>

    <script src="games-data.js"></script>
    <script src="header-functions.js"></script>
    <script>
      // Function to load the header
      function loadHeader() {
        fetch("header.html")
          .then((response) => response.text())
          .then((data) => {
            document.getElementById("header-placeholder").innerHTML = data;
            dropdownPopulate();
            setToggleButton();
            generateContent(); // Ensure generateContent is still called
          });
      }
      function generateContent() {
        const gameGrid = document.getElementById("game-grid");

        if (!gameGrid) {
          console.error("Game grid not found.");
          return;
        }

        // Generate game cards with descriptions and a megaphone button (only if the game has updates)
        games.forEach((game) => {
          const gameCard = document.createElement("div");
          gameCard.className = "game-card relative"; // Use updated class name

          let buttons = "";
          game.urls.forEach((url) => {
            if (url.link) {
              const iconSrc = platformIcons[url.type];
              if (iconSrc) {
                buttons += `
            <a href="${url.link}" target="_blank">
              <div class="platform-icon-container">
                <img src="${iconSrc}" alt="Play on ${
                  url.type.charAt(0).toUpperCase() + url.type.slice(1)
                }" class="platform-icon">
              </div>
            </a>`;
              }
            }
          });

          let flairs = "";
          if (game.isNew) {
            flairs += `
        <div class="new-flair">New</div>`;
          }
          if (game.isUpdated) {
            flairs += `
        <div class="updated-flair">Updated</div>`;
          }

          // Only display the megaphone button if the game has update notes
          let megaphoneButton = "";
          if (game.updateNotes && game.updateNotes.length > 0) {
            megaphoneButton = `
        <button class="absolute top-2 left-2 p-2 bg-gray-700 rounded-full update-btn" data-game-id="${game.id}">
          <i class="fas fa-bullhorn megaphone-icon"></i>
        </button>`;
          }

          gameCard.innerHTML = `
      ${flairs} <!-- Add the flairs dynamically -->
      ${megaphoneButton} <!-- Conditionally add the megaphone button -->
      <img src="${game.imageUrl}" alt="${game.title}" class="w-full h-48 object-cover" />
      <div class="p-5 text-center">
        <h2 class="text-xl font-semibold mb-2">${game.title}</h2>
        <p class="text-sm text-gray-400 mb-4">${game.description}</p>
        <div class="flex justify-center space-x-4">
          ${buttons}
        </div>
      </div>
    `;

          gameGrid.appendChild(gameCard);
        });

        // Add click event listener to all update buttons (for games with updates)
        document.querySelectorAll(".update-btn").forEach((button) => {
          button.addEventListener("click", function () {
            const gameId = this.getAttribute("data-game-id");
            showUpdateModal(gameId);
          });
        });
      }
      function showUpdateModal(gameId) {
        const game = games.find((g) => g.id === gameId);
        if (!game || !game.updateNotes) {
          console.error("No update notes found for game with id", gameId);
          return;
        }

        // Sort update notes based on their date
        game.updateNotes.sort((a, b) => new Date(b.date) - new Date(a.date));

        const updateContent = document.getElementById("update-content");
        updateContent.innerHTML = game.updateNotes
          .map(
            (update) => `
      <div class="update-section mb-6">
        <h3 class="text-lg font-semibold mb-1">Version ${update.version} - ${
              update.title
            }</h3>
        <p class="text-sm text-gray-400 mb-2">${update.date}</p>
        <ul class="list-disc pl-5">
          ${update.notes.map((note) => `<li>${note}</li>`).join("")}
        </ul>
      </div>
    `
          )
          .join("");

        const modal = document.getElementById("updateModal");
        modal.style.display = "block"; // Show the modal
        document.body.classList.add("modal-open"); // Disable body scroll
      }

      // Close modal event listener
      document.querySelector(".close").addEventListener("click", function () {
        document.getElementById("updateModal").style.display = "none";
        document.body.classList.remove("modal-open"); // Re-enable body scroll
      });

      // Close modal when clicking outside the modal content
      window.onclick = function (event) {
        const modal = document.getElementById("updateModal");
        if (event.target === modal) {
          modal.style.display = "none";
          document.body.classList.remove("modal-open"); // Re-enable body scroll
        }
      };

      // Close modal event listener
      document.querySelector(".close").addEventListener("click", function () {
        document.getElementById("updateModal").style.display = "none";
      });

      // Close modal when clicking outside the modal content
      window.onclick = function (event) {
        const modal = document.getElementById("updateModal");
        if (event.target === modal) {
          modal.style.display = "none";
        }
      };

      // Event listener for closing the modal
      document.querySelector(".close").addEventListener("click", function () {
        document.getElementById("updateModal").style.display = "none";
      });

      // To close the modal when clicking outside of the modal content
      window.onclick = function (event) {
        const modal = document.getElementById("updateModal");
        if (event.target === modal) {
          modal.style.display = "none";
        }
      };

      // Close modal functionality
      const modal = document.getElementById("updateModal");
      const span = document.getElementsByClassName("close")[0];
      span.onclick = function () {
        modal.style.display = "none";
      };
      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      window.onload = loadHeader;
    </script>
  </body>
</html>
